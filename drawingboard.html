<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        
    </style>
</head>
<body>
    <button id = 'viewAllTasks'>All Tasks</button>
    <div id = "taskList"></div>
    <dialog id = "allTasksDialog"></dialog>

    <script>
        const viewAllTasksButton = document.getElementById("viewAllTasks");
        const taskList = document.getElementById("taskList");
        const allTasksDialog = document.getElementById("allTasksDialog");

        let allTasks = JSON.parse(localStorage.getItem("allTasks")) || []; // This array will contain all notes to be saved into the local storage of the computer
        console.log(allTasks);
        
        renderNotes(taskList, true);

        function Task(text, date, checked) {
            this.id = Date.now().toString() + Math.random().toString(36).slice(2); // unique id
            this.text = text;
            this.date = date;
            this.completed = checked || false;
        }

        // Create and reuse the close button for the dialog

        viewAllTasksButton.onclick = function () {
            renderNotes(allTasksDialog, false);
            allTasksDialog.appendChild(getCloseButton());
            allTasksDialog.showModal();
        };

        function getCloseButton() {
            let btn = document.getElementById("closeAllTasksModal");
            if (!btn) {
                btn = document.createElement("button");
                btn.id = "closeAllTasksModal";
                btn.textContent = "Close";
                btn.onclick = function () {
                    allTasksDialog.close();
                    renderNotes(taskList, true);
                };
            }
            return btn;
        }

        function renderNotes(renderList, filterDate) {
            renderList.innerHTML = "";
            for (let i = 0; i < allTasks.length; i++) {
                if (allTasks[i].date < new Date().toLocaleDateString('en-CA') && allTasks[i].completed === "completed" && filterDate) {
                    continue;
                }
                singleNoteRender(allTasks[i].text, allTasks[i].date, i, renderList, filterDate);
            }
            renderList.innerHTML += `<button class = "newTaskButton">Add new task</button>`; // Spacer to prevent last note from being hidden behind the add button
            // Only add close button if rendering dialog
            if (renderList === allTasksDialog) {
                renderList.appendChild(getCloseButton());
            }

            const newTaskButton = renderList.querySelector('.newTaskButton');

            newTaskButton.onclick = function newTask() {
                const dateObject = new Date()
                const newTask = new Task("New Task", dateObject.toLocaleDateString('en-CA'), false); // Creates a new note object with text and date
                allTasks.push(newTask); // Adds notes to a single array
                console.log(allTasks);
                localStorage.setItem("allTasks", JSON.stringify(allTasks)) // Saves array into local storage

                renderNotes(renderList, filterDate);
            }
        }

        function singleNoteRender(text, date, index, renderList, filterDate) {
            const task = document.createElement('div');
            const taskId = allTasks[index].id;
            if (allTasks[index].completed === "completed") {
                task.innerHTML = '<input type="checkbox" value="completed" class="taskCheckbox" data-id="' + taskId + '" checked>';
            }
            else {
                task.innerHTML = '<input type="checkbox" value="completed" class="taskCheckbox" data-id="' + taskId + '">';
            }
            task.innerHTML += `<span class="taskText" contentEditable="true" data-id="${taskId}">${text}</span>`;

            if(renderList === allTasksDialog) {
                task.innerHTML += `
                    <input type="date" class="dateDisplay" value="${date}" data-id="${taskId}">
                    <button class="deleteButton" data-id="${taskId}">Delete</button>
                `;
            }

            renderList.appendChild(task);
        }

        // Use event delegation for checkboxes
        [taskList, allTasksDialog].forEach(list => {
            list.addEventListener('change', function (e) {
                if (e.target.classList.contains('taskCheckbox')) {
                    const id = e.target.dataset.id;
                    const task = allTasks.find(t => t.id === id);
                    if (task) {
                        task.completed = e.target.checked ? "completed" : false;
                        localStorage.setItem("allTasks", JSON.stringify(allTasks));
                        renderNotes(list, list === taskList);
                    }
                }
                if (e.target.classList.contains('dateDisplay')) {
                    const id = e.target.dataset.id;
                    const task = allTasks.find(t => t.id === id);
                    if (task) {
                        task.date = e.target.value;
                        localStorage.setItem("allTasks", JSON.stringify(allTasks));
                        renderNotes(list, list === taskList);
                    }
                }
            });
            list.addEventListener('input', function (e) {
                let el = e.target;
                if (el.nodeType === 3) el = el.parentElement;
                if (el.classList && el.classList.contains('taskText')) {
                    const id = el.dataset.id;
                    const task = allTasks.find(t => t.id === id);
                    if (task) {
                        task.text = el.textContent;
                        localStorage.setItem("allTasks", JSON.stringify(allTasks));
                    }
                }
            });
            // Handle delete button clicks
            list.addEventListener('click', function (e) {
                if (e.target.classList.contains('deleteButton')) {
                    const id = e.target.dataset.id;
                    allTasks = allTasks.filter(t => t.id !== id);
                    localStorage.setItem("allTasks", JSON.stringify(allTasks));
                    renderNotes(list, list === taskList);
                }
            });
        });
    </script>
</body>
</html>

<!--
Roadmap
- Progress bar
- Adding goals
- Plant animation

To-do list
    - Adding tasks
        - Similar adding notes to the note taking website
    - Need to add check marks
    - Editing and deleting tasks using modals
        - Close and save buttons are different

Basing tasks on days
    - To-do list has to be based on days
        - Date of task is displayed (date is set to today by default)
        - Date of task can be edited
    - Checked disappear after the day ends (no matter the set date)
    - Unchecked don't disappear after the day ends (switches to exclamation point if past due date)

Progress bar
- Progress bar updates based on to-do list
- Progress bar animation (styling)

- Plant animation (we are not finishing this)
-->