<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        
    </style>
</head>
<body>
    <button id = 'viewAllTasks'>All Tasks</button>
    <div id = "taskList"></div>
    <dialog id = "allTasksDialog"></dialog>

    <button id="clearTasks">clear array</button>

    <script>
        const viewAllTasksButton = document.getElementById("viewAllTasks");
        const taskList = document.getElementById("taskList");
        const allTasksDialog = document.getElementById("allTasksDialog");
        const clearTasksButton = document.getElementById("clearTasks");

        let allTasks = JSON.parse(localStorage.getItem("allTasks")) || []; // This array will contain all notes to be saved into the local storage of the computer
        console.log(allTasks);

        clearTasksButton.onclick = function() {
            allTasks = [];
            localStorage.setItem("allTasks", JSON.stringify(allTasks));
            renderNotes(taskList, true);
        }
        
        renderNotes(taskList, true);

        function Task(text, date, checked) {
            this.id = Date.now().toString() + Math.random().toString(36).slice(2); // unique id
            this.text = text;
            this.date = date;
            this.completed = checked || false;
        }

        // Create and reuse the close button for the dialog
        function getCloseButton() {
            let btn = document.getElementById("closeAllTasksModal");
            if (!btn) {
                btn = document.createElement("button");
                btn.id = "closeAllTasksModal";
                btn.textContent = "Close";
                btn.onclick = function () {
                    allTasksDialog.close();
                    renderNotes(taskList, true);
                };
            }
            return btn;
        }

        viewAllTasksButton.onclick = function () {
            renderNotes(allTasksDialog, false);
            allTasksDialog.appendChild(getCloseButton());
            allTasksDialog.showModal();
        };

        function renderNotes(renderList, filterDate) {
            renderList.innerHTML = "";
            for (let i = 0; i < allTasks.length; i++) {
                if (allTasks[i].date < new Date().toLocaleDateString('en-CA') && allTasks[i].completed === "completed" && filterDate) {
                    continue;
                }
                singleNoteRender(allTasks[i].text, allTasks[i].date, i, renderList, filterDate);
            }
            renderList.innerHTML += `<button class = "newTaskButton">Add new task</button>`; // Spacer to prevent last note from being hidden behind the add button
            // Only add close button if rendering dialog
            if (renderList === allTasksDialog) {
                renderList.appendChild(getCloseButton());
            }

            const newTaskButton = renderList.querySelector('.newTaskButton');

            newTaskButton.onclick = function newTask() {
                const dateObject = new Date()
                const newTask = new Task("New Task", dateObject.toLocaleDateString('en-CA'), false); // Creates a new note object with text and date
                allTasks.push(newTask); // Adds notes to a single array
                console.log(allTasks);
                localStorage.setItem("allTasks", JSON.stringify(allTasks)) // Saves array into local storage

                renderNotes(renderList, filterDate);
            }
        }

        // Use event delegation for checkboxes
        [taskList, allTasksDialog].forEach(list => {
            list.addEventListener('change', function (e) {
                if (e.target.classList.contains('taskCheckbox')) {
                    const index = parseInt(e.target.dataset.index);
                    allTasks[index].completed = e.target.checked ? "completed" : false;
                    localStorage.setItem("allTasks", JSON.stringify(allTasks));
                    renderNotes(list, list === taskList);
                }
                if (e.target.classList.contains('dateDisplay')) {
                    const index = Array.from(list.querySelectorAll('.dateDisplay')).indexOf(e.target);
                    allTasks[index].date = e.target.value;
                    localStorage.setItem("allTasks", JSON.stringify(allTasks));
                    renderNotes(list, list === taskList);
                }

            });
            list.addEventListener('input', function (e) {
                let el = e.target;
                if (el.nodeType === 3) el = el.parentElement;
                if (el.classList && el.classList.contains('taskText')) {
                    const index = Array.from(list.querySelectorAll('.taskText')).indexOf(el);
                    allTasks[index].text = el.textContent;
                    localStorage.setItem("allTasks", JSON.stringify(allTasks));
                }
            });
        });

        function singleNoteRender(text, date, index, renderList, filterDate) {
            const task = document.createElement('div');
            if (allTasks[index].completed === "completed") {
                task.innerHTML = '<input type="checkbox" value="completed" class="taskCheckbox" data-id="${allTasks[index].id}">';
            }
            else {
                task.innerHTML = '<input type="checkbox" value="completed" class="taskCheckbox" data-id="${allTasks[index].id}">';
            }
            task.innerHTML += `
                <span class="taskText" contentEditable="true" data-id="${allTasks[index].id}">${text}</span>
                <input type="date" class="dateDisplay" value="${date}" data-id="${allTasks[index].id}">
            `;

            renderList.appendChild(task);
        }
    </script>
</body>
</html>

<!--
Roadmap
- Progress bar
- Adding goals
- Plant animation

To-do list
    - Adding tasks
        - Similar adding notes to the note taking website
    - Need to add check marks
    - Editing and deleting tasks using modals
        - Close and save buttons are different

Basing tasks on days
    - To-do list has to be based on days
        - Date of task is displayed (date is set to today by default)
        - Date of task can be edited
    - Checked disappear after the day ends (no matter the set date)
    - Unchecked don't disappear after the day ends (switches to exclamation point if past due date)

Progress bar
- Progress bar updates based on to-do list
- Progress bar animation (styling)

- Plant animation (we are not finishing this)
-->